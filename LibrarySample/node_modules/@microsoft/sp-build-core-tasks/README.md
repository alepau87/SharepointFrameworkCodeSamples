# sp-build-core-tasks

A collection of tasks for the SharePoint Framework build system, which is
based on [gulp](http://gulpjs.com/).  The **sp-build-core-tasks** package
implements various SharePoint-specific operations such as packaging solutions,
writing manifests, etc.

# Build properties
The tasks in this package utilize `gulp-core-build`'s build configuration to share
a single configuration across all tasks.

```json
{
  "entries": [
    {
      "entry": "", // The path to the entry point of the bundle
      "manifest": "", // A manifest to associate with this bundle
      "outputPath": "" // Where to write the main bundle to disk
    }
  ],
  "externals": {}, // A mapping of imported modules to a source JavaScript file
  "localizedResources": {} // A mapping of an imported module names to a pattern for detecting standalone bundles
}
```

Usage
```json
{
  "entries": [
    {
      "entry": "./lib/HelloWorldWebPart.js",
      "manifest": "./src/HelloWorldWebPart.manifest.json",
      "outputPath": "./dist/HelloWorldWebPart.bundle.js"
    }
  ],
  "externals": {
    "@microsoft/sp-client-base": "node_modules/@microsoft/sp-client-base/dist/sp-client-base.js",
    "jquery": "https://code.jquery.com/jquery-3.1.0.min.js",
    "contoso-core": {
        "path": "https://contoso.com/contoso.js",
        "globalName": "Contoso"
    },
    "contoso-ui": {
        "path": "/src/ContosoUI.js",
        "globalName": "Contoso",
        "globalDependencies": ["contoso-core"]
    }
  },
  "localizedResources": {
    "strings": "strings/{locale}.js"
  }
}
```

# Tasks

## Package Solution

The schema for the configuration file is as follows:
```javascript
interface IPackageSolutionTaskConfig {
    paths?: {
        /**
         * The packaging root folder. Defaults to './sharepoint'
         */
        packageDir?: string;
        /**
         * The folder to write the raw package to disk for debugging. Defaults to 'solution/debug'
         */
        debugDir?: string;
        /**
         * The name of the spapp to create (including extension) Defaults to 'ClientSolution.spapp'
         */
        zippedPackage?: string;
        /**
         * The folder containing the raw feature_xml to import into the package. Defaults to 'feature_xml'
         */
        featureXmlDir?: string;
        /**
         * The glob to match against to find manifest files. Looks in dist/ when running in normal, but deploy/ for
         *  production
         */
        manifestsMatch?: string;
        /**
         * The path to the folder where manifests are stored. Defaults to buildConfig.distFolder
         */
        manifestDir?: string;
    };
    /**
     * The definition of this solution's package, features, and components
     */
    solution?: ISolution;
}

interface ISolution {
  /**
   * A localizable string used as the name of the app in the App Catalog and the different sites.
   */
  title?: string;
  /**
   *
   */
  supportedLocales?: string[];
  /**
   * Identifies the package in the SharePoint, is a not localized string.
   */
  name: string;
  /*
   * Should be unique GUID
   */
  id: string;
  /**
   * A version number in the format X.X.X.X
   */
  version?: string;
  /**
   * A list of feature definitions. If omitted, a feature will be created for every component
   */
  features?: IFeature[];
}

interface IFeature {
  /**
   * The name of the feature, as can bee seen in the *Site Settings > Manage Site Features* page in SharePoint.
   */
  title: string;
  /**
   * The description on the feature, as can bee seen in the *Site Settings > Manage Site Features* page in SharePoint.
   */
  description: string;
  /**
   * A unique GUID
   */
  id: string;
  /**
   * A version number in the format X.X.X.X
   */
  version?: string;
  /**
   * A list of id's of component Manifests to include in this Feature. If this is omitted, all available
   * components will be added to this feature
   */
  componentIds?: string[];
}
```

### Default Configuration
```json
{
  "paths": {
    "zippedPackage": "ClientSolution.spapp",
  },
  "solution": {
    "name": "A Sample Solution",
    "id": "00000000-0000-0000-0000-000000000000",
    "version": "1.0.0.0"
  }
}
```
### Custom Feature.xml
In order support provisioning of various SharePoint resources (such as List Templates, Pages, or Content Types), custom Feature XML may also be injected into the package. This is used in order to provision resources necessary for applications, but may also be used for WebParts. The documentation for Feature XML is located [here](https://msdn.microsoft.com/en-us/library/office/ms475601.aspx?f=255&MSPPError=-2147217396).

By default, the packaging task looks for the custom Feature XML in `./sharepoint/feature_xml`. Every file in this folder will be included in the final application package. However, the task relies on the contents of the `_rels/` folder to determine which custom features are defined. Essentially, it assumes that each `.xml.rels` file is related to a feature.xml of the same name at the top level of the `feature_xml/`, and will add a relationship to the `AppManifest.xml.rels` file including that Feature in the package.


### Localize package resources

Resources (*.resx) files can be added to the package to provide localization to different parts of the solution.

**Resources\Resources.resx** file is the default localization that will be used if a suitable file can't be found for the web language. It's recommended that this matches the English file.

**Resources\Resources.LL-CC.resx** file is the localization for LL-CC locale, where LL and CC are [Internet Engineering Task Force (IETF)-compliant](http://tools.ietf.org/html/rfc1766) language and culture codes. Examples of this are **Resources\Resources.en-US.rex** or **Resources\Resources.es-ES.resx**

Fully formed resources files are provided with the sample packages.

In order to localize in a new language, create a new Resources.LL-CC.resx file and add the localized data there.

Although there are different parts of the package that can be localized (the manifest, and each feature separately), the same resources files are used throughout the packages, for simplicity. Custom features may or may not use the same resources files, at the developer discretion.

#### How to use
1. To ensure that the string will be localized, check that *_rels\AppManifest.xml.rels* file contains the references to the resources files, just like in the following example:
    ```xml
    <Relationship Type="http://schemas.microsoft.com/sharepoint/2012/app/relationships/content-resource" Target="/Resources/Resources.en-US.resx" Id="r1"></Relationship>
    <Relationship Type="http://schemas.microsoft.com/sharepoint/2012/app/relationships/content-defaultresource" Target="/Resources/Resources.resx" Id="r2"></Relationship>
    ```

    **gulp package-solution** will create these references automatically, as long as the files exist in the **sharepoint\feature_xml** directory

1. Update a localized string field (Solution.Title, Feature.Title, Feature.Description) to something matching the following pattern:
    `$Resources:myAppTitle;`

    If you don't want a localized string, simply type the string directly.

If the features are automatically generated there will be no localized strings for them.


#### Custom feature localization

Any custom Feature XML will be able to reference the RESX file in the package.

#### Filter by supported locales

Supported locales are used to restrict the locales where an app can be installed, ensuring that the experience will be as good as expected. This can work by either ensuring that the app is localized in the language, or by assuming that the default language strings can be acceptable in that locale (i.e. English can be acceptable in Netherlands but not in Germany).

In order to support this, on the **package-solution.json** file there's a optional field *supportedLocales*.

Example: ` "supportedLocales": ["en-US", "es-ES", "fr-FR"]`

By not providing a list of supported locales, the app will be available to all locales using the default resources file if localized resources are not available.



*This package is part of the [SharePoint Framework](https://github.com/SharePoint/sp-dev-docs/wiki),
which is a collection of NPM packages that empower developers to create client-side experiences
for [Microsoft SharePoint](https://products.office.com/en-us/sharepoint/collaboration).
The SharePoint Framework is currently in Preview, and is subject to change based on customer feedback.
For more information, including API documentation and code samples, please visit the
[SharePoint Framework Developer Preview](https://github.com/SharePoint/sp-dev-docs/wiki) web site.*
